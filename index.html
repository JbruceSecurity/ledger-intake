<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ledger Intake (Admin)</title>
  <style>
    body { font-family: -apple-system, system-ui, Arial; padding: 14px; max-width: 1100px; margin: 0 auto; }
    h1 { margin: 0 0 10px; }
    .muted { color:#666; font-size: 13px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    label { display: block; font-size: 14px; margin: 10px 0 6px; }
    input, select, button { width: 100%; font-size: 16px; padding: 10px; box-sizing: border-box; }
    button { cursor: pointer; }
    .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .msg { margin: 10px 0; font-weight: 700; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; vertical-align: top; }
    th { background: #f5f5f5; text-align: left; }
    .pill { display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid #ddd; }
    .topbar { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .topbar > * { flex: 0 0 auto; }
    .topbar button { width:auto; }
    .right { margin-left:auto; }
    .danger { border:1px solid #f2b8b5; background:#fff5f5; padding:10px; border-radius:10px; }
    .ok { border:1px solid #bde5c8; background:#f4fff7; padding:10px; border-radius:10px; }
    .small { font-size: 12px; }
  </style>
</head>
<body>
  <h1>Ledger Intake (Admin)</h1>
  <div class="muted">
    Admin creates/updates POs. Status stays <b>Queue</b> until officers check in.<br/>
    Door rules: If ledger door is blank → Grocery→56, Produce/Dairy→93, Meat/Frozen→132.
  </div>

  <div class="danger" style="margin-top:12px;">
    <b>Admin PIN required.</b> Officers should use: <code>/board.html</code>
  </div>

  <div class="topbar" style="margin-top:12px;">
    <button id="refreshBtn">Refresh</button>
    <button id="exportBtn">Export CSV (Leadership)</button>
    <button id="archiveBtn">Archive Checked-In (8 hrs)</button>

    <label class="small" style="display:flex; align-items:center; gap:8px; margin:0;">
      <input id="showArchived" type="checkbox" style="width:auto; transform:scale(1.2);" />
      Show archived
    </label>

    <div class="right muted small">Officer link: <a href="./board.html" target="_blank">board.html</a></div>
  </div>

  <p class="msg" id="msg"></p>

  <form id="form" class="ok">
    <label>PO Number (exactly 5 digits)*</label>
    <input id="po" maxlength="5" inputmode="numeric" placeholder="12345" required />

    <div class="row">
      <div>
        <label>Carrier</label>
        <input id="carrier" placeholder="e.g., Swift" />
      </div>
      <div>
        <label>Shipper</label>
        <input id="shipper" placeholder="e.g., Vendor name" />
      </div>
    </div>

    <label>Department*</label>
    <select id="department" required>
      <option value="">Select department</option>
      <option>Grocery</option>
      <option>Produce/Dairy</option>
      <option>Meat/Frozen</option>
    </select>

    <label>Ledger Door (optional)</label>
    <input id="ledgerDoor" placeholder="From warehouse ledger (may be blank)" />

    <label>Notes (optional)</label>
    <input id="notes" placeholder="Short note for officers (optional)" />

    <div class="actions">
      <button type="submit">Save / Update (Queue)</button>
      <button type="button" id="clearBtn">Clear</button>
    </div>
  </form>

  <label style="margin-top:14px;">Search PO</label>
  <input id="search" maxlength="5" inputmode="numeric" placeholder="Type PO digits…" />

  <div id="tableWrap"></div>

  <script type="module">
    // ====== ADMIN PIN (set yours) ======
    const ADMIN_PIN = "1234"; // <-- set your real pin

    // ====== Supabase ======
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    const SUPABASE_URL = "https://pxiigthkswhnivanndfn.supabase.co";
    const SUPABASE_KEY = "sb_publishable_fWVXeZM0mcylqczc6DWztA_Fu63kfj0";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // ====== PIN gate (UI-only) ======
    if (sessionStorage.getItem("admin_ok") !== "1") {
      const entered = prompt("Admin PIN:");
      if (entered !== ADMIN_PIN) {
        alert("Wrong PIN. Opening Officer Board instead.");
        location.href = "./board.html";
      } else {
        sessionStorage.setItem("admin_ok", "1");
      }
    }

    // ====== Elements ======
    const msg = document.getElementById("msg");
    const form = document.getElementById("form");
    const tableWrap = document.getElementById("tableWrap");
    const refreshBtn = document.getElementById("refreshBtn");
    const exportBtn = document.getElementById("exportBtn");
    const archiveBtn = document.getElementById("archiveBtn");
    const showArchived = document.getElementById("showArchived");
    const clearBtn = document.getElementById("clearBtn");
    const search = document.getElementById("search");

    const po = document.getElementById("po");
    const carrier = document.getElementById("carrier");
    const shipper = document.getElementById("shipper");
    const department = document.getElementById("department");
    const ledgerDoor = document.getElementById("ledgerDoor");
    const notes = document.getElementById("notes");

    let lastRows = [];

    function isFiveDigits(v){ return /^[0-9]{5}$/.test(v); }
    function pill(t){ return `<span class="pill">${t}</span>`; }

    function defaultDoorForDept(dept){
      if (dept === "Grocery") return "56";
      if (dept === "Produce/Dairy") return "93";
      if (dept === "Meat/Frozen") return "132";
      return "";
    }

    function instructionDoor(r){
      // ledger door wins; else default by dept
      return (r.ledger_door || "").trim() || defaultDoorForDept(r.department);
    }

    function instructionText(r){
      const d = instructionDoor(r);
      return d ? `Check in at Door ${d}` : "Check in (door not set)";
    }

    function render(rows){
      const q = (search.value || "").trim();
      const view = q ? rows.filter(r => String(r.po_number || "").includes(q)) : rows;

      if (!view.length){
        tableWrap.innerHTML = `<p class="muted">No rows.</p>`;
        return;
      }

      tableWrap.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>PO</th>
              <th>Carrier</th>
              <th>Shipper</th>
              <th>Dept</th>
              <th>Status</th>
              <th>Ledger Door</th>
              <th>Instruction</th>
              <th>Updated</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${view.map(r => {
              const updated = r.last_updated ? new Date(r.last_updated).toLocaleString() : "";
              return `
                <tr>
                  <td><b>${r.po_number || ""}</b></td>
                  <td>${r.carrier || ""}</td>
                  <td>${r.shipper || ""}</td>
                  <td>${r.department || ""}</td>
                  <td>${pill(r.status || "")}</td>
                  <td>${r.ledger_door || ""}</td>
                  <td>${instructionText(r)}</td>
                  <td>${updated}</td>
                  <td style="min-width:170px;">
                    <button data-edit="${r.id}">Edit</button>
                    <button data-del="${r.id}">Delete</button>
                    ${r.archived ? `<button data-restore="${r.id}">Restore</button>` : ``}
                  </td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      `;
    }

    async function loadRows(){
      msg.textContent = "Loading…";

      const includeArchived = showArchived.checked;
      let q = supabase
        .from("trucks")
        .select("*")
        .order("last_updated", { ascending: false });

      if (!includeArchived) q = q.eq("archived", false);

      const { data, error } = await q;
      if (error){
        msg.textContent = `Load error: ${error.message}`;
        return;
      }
      msg.textContent = "";
      lastRows = data || [];
      render(lastRows);
    }

    function clearForm(){
      po.value = "";
      carrier.value = "";
      shipper.value = "";
      department.value = "";
      ledgerDoor.value = "";
      notes.value = "";
      msg.textContent = "";
    }

    // Save/Update (status forced to Queue) + Duplicate PO warning
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      msg.textContent = "";

      const poVal = po.value.trim();
      if (!isFiveDigits(poVal)) return (msg.textContent = "PO must be exactly 5 digits.");
      if (!department.value) return (msg.textContent = "Department is required.");

      msg.textContent = "Saving…";

      const payload = {
        po_number: poVal,
        carrier: carrier.value.trim() || null,
        shipper: shipper.value.trim() || null,
        department: department.value,
        ledger_door: ledgerDoor.value.trim() || null,
        notes: notes.value.trim() || null,
        status: "Queue",
        archived: false,
        archived_at: null,
        last_updated: new Date().toISOString(),
      };

      const existingAny = lastRows.find(r => r.po_number === poVal);
      let res;

      if (existingAny && !existingAny.archived) {
        const ok = confirm(`PO ${poVal} already exists. Update it?`);
        if (!ok) { msg.textContent = "Canceled (no changes)."; return; }
        res = await supabase.from("trucks").update(payload).eq("id", existingAny.id);

      } else if (existingAny && existingAny.archived) {
        const ok = confirm(`PO ${poVal} is archived. Restore + update it?`);
        if (!ok) { msg.textContent = "Canceled (no changes)."; return; }
        res = await supabase.from("trucks").update(payload).eq("id", existingAny.id);

      } else {
        res = await supabase.from("trucks").insert([payload]);
      }

      if (res.error){
        msg.textContent = `Save error: ${res.error.message}`;
        return;
      }

      msg.textContent = "Saved.";
      clearForm();
      await loadRows();
    });

    // Search
    search.addEventListener("input", () => render(lastRows));

    // Buttons
    refreshBtn.addEventListener("click", loadRows);
    clearBtn.addEventListener("click", clearForm);
    showArchived.addEventListener("change", loadRows);

    // Archive (8 hours) — requires the SQL function you created
    archiveBtn.addEventListener("click", async () => {
      msg.textContent = "Archiving…";
      const { error } = await supabase.rpc("archive_old_trucks", { hours_old: 8 });
      if (error) return (msg.textContent = `Archive error: ${error.message}`);
      msg.textContent = "Archived old Checked-In rows.";
      await loadRows();
    });

    // Export CSV (Leadership)
    exportBtn.addEventListener("click", () => {
      const rows = lastRows.slice(); // currently loaded
      const headers = [
        "po_number","carrier","shipper","department","ledger_door","instruction_door","status",
        "last_updated","archived","archived_at","notes"
      ];

      const csv = [
        headers.join(","),
        ...rows.map(r => {
          const instruction_door = instructionDoor(r);
          const vals = [
            r.po_number,
            r.carrier || "",
            r.shipper || "",
            r.department || "",
            r.ledger_door || "",
            instruction_door || "",
            r.status || "",
            r.last_updated || "",
            String(!!r.archived),
            r.archived_at || "",
            (r.notes || "")
          ].map(v => `"${String(v ?? "").replaceAll('"','""')}"`);
          return vals.join(",");
        })
      ].join("\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const a = document.createElement("a");
      const date = new Date().toISOString().slice(0,10);
      a.href = URL.createObjectURL(blob);
      a.download = `pwadc_ledger_report_${date}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
      msg.textContent = "CSV downloaded.";
    });

    // Table actions: edit/delete/restore
    tableWrap.addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;

      const editId = btn.getAttribute("data-edit");
      const delId = btn.getAttribute("data-del");
      const restoreId = btn.getAttribute("data-restore");

      if (editId) {
        const r = lastRows.find(x => String(x.id) === String(editId));
        if (!r) return;
        po.value = r.po_number || "";
        carrier.value = r.carrier || "";
        shipper.value = r.shipper || "";
        department.value = r.department || "";
        ledgerDoor.value = r.ledger_door || "";
        notes.value = r.notes || "";
        msg.textContent = "Loaded row for editing.";
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      if (delId) {
        if (!confirm("Delete this row?")) return;
        msg.textContent = "Deleting…";
        const { error } = await supabase.from("trucks").delete().eq("id", delId);
        if (error) return (msg.textContent = `Delete error: ${error.message}`);
        msg.textContent = "Deleted.";
        await loadRows();
      }

      if (restoreId) {
        msg.textContent = "Restoring…";
        const { error } = await supabase
          .from("trucks")
          .update({ archived: false, archived_at: null, last_updated: new Date().toISOString(), status: "Queue" })
          .eq("id", restoreId);
        if (error) return (msg.textContent = `Restore error: ${error.message}`);
        msg.textContent = "Restored.";
        await loadRows();
      }
    });

    // Initial load
    loadRows();
  </script>
</body>
</html>
