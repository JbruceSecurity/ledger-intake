<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ledger Intake (Admin)</title>

  <style>
    body { font-family: system-ui, -apple-system, Arial; padding: 16px; }
    h1 { margin-bottom: 6px; }
    .note { color:#555; font-size:14px; margin-bottom:16px; line-height: 1.35; }
    label { font-weight:600; display:block; margin-top:14px; }
    input, select, button { width:100%; padding:12px; font-size:16px; margin-top:6px; box-sizing: border-box; }
    button { cursor:pointer; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .msg { margin-top:12px; font-weight:600; }
    table { width:100%; border-collapse:collapse; margin-top:16px; }
    th, td { border:1px solid #ddd; padding:10px; font-size:14px; vertical-align: top; }
    th { background:#f5f5f5; text-align: left; }
    .btns { display:flex; gap:8px; flex-wrap: wrap; }
    .btns button { width:auto; padding:8px 10px; font-size:14px; }
    .muted { color:#666; font-size:13px; }

    /* Toggle row */
    .toolbar { display:flex; align-items:center; gap:10px; margin: 14px 0 6px; }
    .toolbar input[type="checkbox"] { width:auto; margin:0; transform: scale(1.2); }
  </style>
</head>

<body>
<h1>Ledger Intake (Admin)</h1>

<div class="note">
  Admin creates & edits POs. Status stays <b>Queue</b> until officers check in.
  <br>
  If no ledger door: Grocery → 56, Produce/Dairy → 93, Meat/Frozen → 132.
  <br>
  <span class="muted">Archive hides a row from boards without deleting it. Use “Show Archived” to restore.</span>
</div>

<form id="form">
  <label>PO Number (5 digits)</label>
  <input id="po" maxlength="5" inputmode="numeric" required />

  <div class="row">
    <div>
      <label>Carrier</label>
      <input id="carrier" />
    </div>
    <div>
      <label>Shipper</label>
      <input id="shipper" />
    </div>
  </div>

  <label>Department</label>
  <select id="department" required>
    <option value="">Select department</option>
    <option>Grocery</option>
    <option>Produce/Dairy</option>
    <option>Meat/Frozen</option>
  </select>

  <label>Ledger Door (optional)</label>
  <input id="ledger_door" placeholder="Leave blank if not assigned" />

  <label>Notes (optional)</label>
  <input id="notes" />

  <button type="submit">Save / Update</button>
</form>

<div class="msg" id="msg"></div>

<div class="toolbar">
  <label style="margin:0; font-weight:600;">Search PO</label>
  <input id="search" placeholder="Type PO digits…" inputmode="numeric" maxlength="5" style="flex:1; margin-top:0;" />
</div>

<div class="toolbar">
  <input type="checkbox" id="showArchived" />
  <label for="showArchived" style="margin:0; font-weight:600;">Show Archived</label>
</div>

<div id="tableWrap"></div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const supabase = createClient(
  "https://pxiigthkswhnivanndfn.supabase.co",
  "sb_publishable_fWVXeZM0mcylqczc6DWztA_Fu63kfj0"
);

const form = document.getElementById("form");
const tableWrap = document.getElementById("tableWrap");
const msg = document.getElementById("msg");
const search = document.getElementById("search");
const showArchived = document.getElementById("showArchived");

// Inputs
const po = document.getElementById("po");
const carrier = document.getElementById("carrier");
const shipper = document.getElementById("shipper");
const department = document.getElementById("department");
const ledger_door = document.getElementById("ledger_door");
const notes = document.getElementById("notes");

let rows = [];

function isFiveDigits(v) {
  return /^\d{5}$/.test(String(v || "").trim());
}

function autoDoor(dept) {
  if (dept === "Grocery") return "56";
  if (dept === "Produce/Dairy") return "93";
  if (dept === "Meat/Frozen") return "132";
  return "";
}

function doorForRow(r) {
  const ld = (r.ledger_door ?? "").toString().trim();
  return ld ? ld : autoDoor(r.department);
}

async function loadRows() {
  msg.textContent = "Loading…";

  const wantArchived = showArchived.checked;

  // If Show Archived is OFF: only non-archived
  // If ON: show both archived and non-archived
  let query = supabase
    .from("trucks")
    .select("po_number, department, ledger_door, carrier, shipper, notes, status, last_updated, archived")
    .order("last_updated", { ascending:false });

  if (!wantArchived) query = query.eq("archived", false);

  const { data, error } = await query;

  if (error) {
    msg.textContent = `Load error: ${error.message}`;
    rows = [];
    render();
    return;
  }

  msg.textContent = "";
  rows = data || [];
  render();
}

function render() {
  const q = search.value.trim();
  const view = q ? rows.filter(r => String(r.po_number || "").includes(q)) : rows;

  if (!view.length) {
    tableWrap.innerHTML = "<p class='muted'>No records</p>";
    return;
  }

  tableWrap.innerHTML = `
    <table>
      <thead>
        <tr>
          <th style="width:110px;">PO</th>
          <th style="width:140px;">Dept</th>
          <th style="width:120px;">Door</th>
          <th style="width:110px;">Status</th>
          <th>Notes</th>
          <th style="width:210px;">Actions</th>
        </tr>
      </thead>
      <tbody>
        ${view.map(r => {
          const updated = r.last_updated ? new Date(r.last_updated).toLocaleString() : "";
          const isArchived = !!r.archived;

          return `
            <tr>
              <td><b>${r.po_number || ""}</b><div class="muted">${updated}</div></td>
              <td>${r.department || ""}${isArchived ? " <span class='muted'>(Archived)</span>" : ""}</td>
              <td><b>${doorForRow(r) || "—"}</b></td>
              <td>${r.status || "Queue"}</td>
              <td>${r.notes || ""}</td>
              <td>
                <div class="btns">
                  <button data-edit="${r.po_number}">Edit</button>
                  ${
                    isArchived
                      ? `<button data-restore="${r.po_number}">Restore</button>`
                      : `<button data-archive="${r.po_number}">Archive</button>`
                  }
                </div>
              </td>
            </tr>
          `;
        }).join("")}
      </tbody>
    </table>
  `;
}

// Save / Update (Admin always writes Queue)
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  msg.textContent = "";

  const poVal = po.value.trim();
  if (!isFiveDigits(poVal)) {
    msg.textContent = "PO must be exactly 5 digits.";
    return;
  }

  if (!department.value) {
    msg.textContent = "Department is required.";
    return;
  }

  const record = {
    po_number: poVal,
    carrier: carrier.value.trim() || null,
    shipper: shipper.value.trim() || null,
    department: department.value,
    ledger_door: ledger_door.value.trim() || null,
    notes: notes.value.trim() || null,

    // RULES
    status: "Queue",
    archived: false,            // if you re-enter a PO, it comes back

    last_updated: new Date().toISOString()
  };

  msg.textContent = "Saving…";
  const { error } = await supabase
    .from("trucks")
    .upsert(record, { onConflict:"po_number" });

  if (error) {
    msg.textContent = `Save error: ${error.message}`;
    return;
  }

  msg.textContent = "Saved (Queue).";
  form.reset();
  await loadRows();
});

search.addEventListener("input", render);
showArchived.addEventListener("change", loadRows);

// Edit + Archive + Restore
tableWrap.addEventListener("click", async (e) => {
  const editBtn = e.target.closest("button[data-edit]");
  const archiveBtn = e.target.closest("button[data-archive]");
  const restoreBtn = e.target.closest("button[data-restore]");

  // EDIT
  if (editBtn) {
    const poNum = editBtn.dataset.edit;
    const r = rows.find(x => String(x.po_number) === String(poNum));
    if (!r) return;

    po.value = r.po_number || "";
    carrier.value = r.carrier || "";
    shipper.value = r.shipper || "";
    department.value = r.department || "";
    ledger_door.value = r.ledger_door || "";
    notes.value = r.notes || "";
    msg.textContent = "Loaded for editing. Update fields → Save/Update.";
    return;
  }

  // ARCHIVE
  if (archiveBtn) {
    const poNum = archiveBtn.dataset.archive;
    const ok = confirm(`Archive PO ${poNum}?`);
    if (!ok) return;

    msg.textContent = `Archiving PO ${poNum}…`;
    const { error } = await supabase
      .from("trucks")
      .update({ archived: true, last_updated: new Date().toISOString() })
      .eq("po_number", poNum);

    if (error) {
      msg.textContent = `Archive failed: ${error.message}`;
      return;
    }

    msg.textContent = `Archived PO ${poNum}.`;
    await loadRows();
    return;
  }

  // RESTORE
  if (restoreBtn) {
    const poNum = restoreBtn.dataset.restore;
    const ok = confirm(`Restore PO ${poNum}?`);
    if (!ok) return;

    msg.textContent = `Restoring PO ${poNum}…`;
    const { error } = await supabase
      .from("trucks")
      .update({ archived: false, last_updated: new Date().toISOString() })
      .eq("po_number", poNum);

    if (error) {
      msg.textContent = `Restore failed: ${error.message}`;
      return;
    }

    msg.textContent = `Restored PO ${poNum}.`;
    await loadRows();
  }
});

loadRows();
</script>
</body>
</html>
