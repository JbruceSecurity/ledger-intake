<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PWADC Ledger - Check-In</title>

  <style>
    :root { --b:#ddd; --muted:#666; --danger:#b00020; --ok:#0a7a2f; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 14px; max-width: 720px; margin: 0 auto; }
    h1 { margin: 6px 0 2px; }
    .muted { color: var(--muted); }
    input, select, button, textarea { width: 100%; font-size: 18px; padding: 12px; box-sizing: border-box; }
    textarea { min-height: 90px; resize: vertical; }
    .row { display:flex; gap:10px; margin-top:10px; }
    .row > * { flex:1; }
    .card { border:1px solid var(--b); border-radius:12px; padding:12px; margin-top:12px; }
    .big { font-size: 20px; font-weight: 800; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--b); font-size: 14px; }
    .hidden { display:none; }
    .msg { margin-top:10px; padding:10px 12px; border-radius:10px; border:1px solid var(--b); }
    .msg.ok { border-color: rgba(10,122,47,.35); color: var(--ok); }
    .msg.err { border-color: rgba(176,0,32,.35); color: var(--danger); }
    .btn { font-weight: 800; cursor: pointer; }
    .btn:disabled { opacity: .55; cursor: not-allowed; }
    .divider { height: 1px; background: var(--b); margin: 12px 0; }
  </style>

  <!-- Supabase UMD -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>

<body>
  <h1>Officer Check-In</h1>
  <div class="muted">Search PO → review details → press Check In</div>

  <div class="card">
    <div class="big">Find PO</div>
    <div style="margin-top:10px;">
      <input id="poSearch" placeholder="Enter PO (e.g., 12345)" inputmode="numeric" />
    </div>

    <div class="row">
      <button class="btn" id="btnSearch">Search</button>
      <button class="btn" id="btnClear" type="button">Clear</button>
    </div>

    <div id="msgTop" class="msg hidden"></div>
  </div>

  <div id="detailsCard" class="card hidden">
    <div class="big">PO Details</div>
    <div class="muted" style="margin-top:6px;">Edit if needed, then Check In.</div>

    <div class="divider"></div>

    <div class="row">
      <div>
        <label class="muted">PO</label>
        <input id="po" placeholder="PO" />
      </div>
      <div>
        <label class="muted">Door</label>
        <input id="door" placeholder="Door (optional)" />
      </div>
    </div>

    <div class="row">
      <div>
        <label class="muted">Department</label>
        <input id="department" placeholder="Dept (optional)" />
      </div>
      <div>
        <label class="muted">Status</label>
        <select id="status">
          <option value="Queue">Queue</option>
          <option value="Checked In">Checked In</option>
          <option value="Arrived">Arrived</option>
        </select>
      </div>
    </div>

    <div style="margin-top:10px;">
      <label class="muted">Notes</label>
      <textarea id="notes" placeholder="Notes (optional)"></textarea>
    </div>

    <div class="row">
      <button class="btn" id="btnCheckIn">Check In</button>
      <button class="btn" id="btnSave">Save</button>
    </div>

    <div id="msgBottom" class="msg hidden"></div>
  </div>

  <script>
    /***********************
     * CONFIG (EDIT THESE)
     ***********************/
    const SUPABASE_URL = "PASTE_YOUR_SUPABASE_URL_HERE";
    const SUPABASE_ANON_KEY = "PASTE_YOUR_SUPABASE_ANON_KEY_HERE";

    // Table name
    const TABLE = "trucks";

    // IMPORTANT:
    // This code intentionally does NOT send `carrier` or `shipper`.

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /***********************
     * HELPERS
     ***********************/
    const $ = (id) => document.getElementById(id);

    function showMsg(el, text, type) {
      el.textContent = text;
      el.className = "msg " + (type === "ok" ? "ok" : "err");
      el.classList.remove("hidden");
    }
    function hideMsg(el) {
      el.classList.add("hidden");
      el.textContent = "";
      el.className = "msg hidden";
    }
    function normalizePO(v) {
      return (v || "").trim();
    }

    function getFormData() {
      return {
        po: normalizePO($("po").value),
        door: ($("door").value || "").trim() || null,
        department: ($("department").value || "").trim() || null,
        status: $("status").value || "Queue",
        notes: ($("notes").value || "").trim() || null,
        // carrier: intentionally removed
        // shipper: intentionally removed
      };
    }

    function fillForm(row) {
      $("po").value = row?.po ?? "";
      $("door").value = row?.door ?? "";
      $("department").value = row?.department ?? "";
      $("status").value = row?.status ?? "Queue";
      $("notes").value = row?.notes ?? "";
    }

    function setLoading(isLoading) {
      $("btnSearch").disabled = isLoading;
      $("btnCheckIn").disabled = isLoading;
      $("btnSave").disabled = isLoading;
    }

    /***********************
     * ACTIONS
     ***********************/
    async function searchPO() {
      hideMsg($("msgTop"));
      hideMsg($("msgBottom"));
      $("detailsCard").classList.add("hidden");

      const po = normalizePO($("poSearch").value);
      if (!po) {
        showMsg($("msgTop"), "Enter a PO number first.", "err");
        return;
      }

      setLoading(true);
      try {
        // If PO is numeric in your DB, you may need: .eq("po", Number(po))
        const { data, error } = await supabase
          .from(TABLE)
          .select("*")
          .eq("po", po)
          .limit(1);

        if (error) throw error;

        if (!data || data.length === 0) {
          // Not found — show empty form so user can create it
          fillForm({ po, status: "Queue" });
          $("detailsCard").classList.remove("hidden");
          showMsg($("msgTop"), "PO not found. You can create it by saving/checking in.", "err");
          return;
        }

        fillForm(data[0]);
        $("detailsCard").classList.remove("hidden");
        showMsg($("msgTop"), "PO found. Review details below.", "ok");
      } catch (e) {
        showMsg($("msgTop"), `Search error: ${e.message || e}`, "err");
      } finally {
        setLoading(false);
      }
    }

    async function saveOnly() {
      hideMsg($("msgBottom"));

      const payload = getFormData();
      if (!payload.po) {
        showMsg($("msgBottom"), "PO is required.", "err");
        return;
      }

      setLoading(true);
      try {
        // Upsert by PO (requires a unique constraint on trucks.po for best results)
        const { error } = await supabase
          .from(TABLE)
          .upsert(payload, { onConflict: "po" });

        if (error) throw error;

        showMsg($("msgBottom"), "Saved successfully.", "ok");
      } catch (e) {
        showMsg($("msgBottom"), `Save error: ${e.message || e}`, "err");
      } finally {
        setLoading(false);
      }
    }

    async function checkIn() {
      hideMsg($("msgBottom"));

      const payload = getFormData();
      if (!payload.po) {
        showMsg($("msgBottom"), "PO is required.", "err");
        return;
      }

      // Force status to Checked In on check-in button
      payload.status = "Checked In";

      setLoading(true);
      try {
        const { error } = await supabase
          .from(TABLE)
          .upsert(payload, { onConflict: "po" });

        if (error) throw error;

        showMsg($("msgBottom"), "Checked In ✅", "ok");
      } catch (e) {
        showMsg($("msgBottom"), `Check-in error: ${e.message || e}`, "err");
      } finally {
        setLoading(false);
      }
    }

    function clearAll() {
      $("poSearch").value = "";
      fillForm({ po: "", door: "", department: "", status: "Queue", notes: "" });
      $("detailsCard").classList.add("hidden");
      hideMsg($("msgTop"));
      hideMsg($("msgBottom"));
    }

    /***********************
     * WIRE UP
     ***********************/
    $("btnSearch").addEventListener("click", searchPO);
    $("btnClear").addEventListener("click", clearAll);
    $("btnSave").addEventListener("click", saveOnly);
    $("btnCheckIn").addEventListener("click", checkIn);

    $("poSearch").addEventListener("keydown", (e) => {
      if (e.key === "Enter") searchPO();
    });
  </script>
</body>
</html>
