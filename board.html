<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Officer Board</title>
  <style>
    body { font-family: -apple-system, system-ui, Arial; padding: 14px; max-width: 1100px; margin: 0 auto; }
    h1 { margin: 0 0 10px; }
    .muted { color:#666; font-size: 13px; }
    input, button { font-size: 18px; padding: 12px; width: 100%; box-sizing: border-box; }
    button { cursor: pointer; }
    .row { display:flex; gap:10px; margin-top:10px; flex-wrap: wrap; }
    .row > * { flex:1; min-width: 160px; }
    table { width:100%; border-collapse: collapse; margin-top:12px; }
    th, td { border:1px solid #ddd; padding:8px; font-size:14px; vertical-align: top; }
    th { background:#f5f5f5; text-align:left; }
    .pill { display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid #ddd; }
    .msg { margin: 10px 0; font-weight: 700; }
    .stats { display:flex; gap:10px; flex-wrap: wrap; margin-top: 8px; }
    .stat { border:1px solid #ddd; border-radius: 12px; padding: 8px 10px; font-size: 13px; }
    .small { font-size: 12px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <h1>Officer Board</h1>
  <div class="muted">
    Search PO → verify instruction → tap <b>Checked In</b>.
    Undo is available for 5 minutes after check-in.
    Door rules: ledger door wins; otherwise Grocery→56, Produce/Dairy→93, Meat/Frozen→132.
  </div>

  <div class="stats" id="stats">
    <div class="stat"><b>Total:</b> <span id="cTotal">0</span></div>
    <div class="stat"><b>Queue:</b> <span id="cQueue">0</span></div>
    <div class="stat"><b>Checked In:</b> <span id="cChecked">0</span></div>
  </div>

  <p class="msg" id="msg"></p>

  <label style="display:block; margin-top:10px;">Search PO</label>
  <input id="searchPO" maxlength="5" inputmode="numeric" placeholder="Type PO digits…" />

  <div class="row">
    <button id="scanBolBtn">Scan BOL (find PO)</button>
    <button id="refreshBtn">Refresh</button>
    <button id="clearSearchBtn" type="button">Clear Search</button>
  </div>

  <!-- Hidden camera/file input for BOL scanning -->
  <input id="bolFile" class="hidden" type="file" accept="image/*" capture="environment" />

  <div id="tableWrap"></div>

  <!-- OCR library (Tesseract.js) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    const SUPABASE_URL = "https://pxiigthkswhnivanndfn.supabase.co";
    const SUPABASE_KEY = "sb_publishable_fWVXeZM0mcylqczc6DWztA_Fu63kfj0";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const msg = document.getElementById("msg");
    const tableWrap = document.getElementById("tableWrap");
    const refreshBtn = document.getElementById("refreshBtn");
    const searchPO = document.getElementById("searchPO");
    const clearSearchBtn = document.getElementById("clearSearchBtn");

    const scanBolBtn = document.getElementById("scanBolBtn");
    const bolFile = document.getElementById("bolFile");

    const cTotal = document.getElementById("cTotal");
    const cQueue = document.getElementById("cQueue");
    const cChecked = document.getElementById("cChecked");

    let lastRows = [];

    function pill(t){ return `<span class="pill">${t}</span>`; }

    function defaultDoorForDept(dept){
      if (dept === "Grocery") return "56";
      if (dept === "Produce/Dairy") return "93";
      if (dept === "Meat/Frozen") return "132";
      return "";
    }

    function instructionDoor(r){
      return (r.ledger_door || "").trim() || defaultDoorForDept(r.department);
    }

    function instructionText(r){
      const d = instructionDoor(r);
      return d ? `Check in at Door ${d}` : "Check in (door not set)";
    }

    function canUndo(r) {
      if ((r.status || "") !== "Checked In") return false;
      if (!r.last_updated) return false;
      const ageMs = Date.now() - new Date(r.last_updated).getTime();
      return ageMs <= 5 * 60 * 1000; // 5 minutes
    }

    function updateCounters(rows){
      const total = rows.length;
      const queue = rows.filter(r => (r.status || "") === "Queue").length;
      const checked = rows.filter(r => (r.status || "") === "Checked In").length;

      cTotal.textContent = String(total);
      cQueue.textContent = String(queue);
      cChecked.textContent = String(checked);
    }

    function render(rows){
      updateCounters(rows);

      const q = (searchPO.value || "").trim();
      const view = q ? rows.filter(r => String(r.po_number || "").includes(q)) : rows;

      if (!view.length){
        tableWrap.innerHTML = "<p class='muted'>No matching rows.</p>";
        return;
      }

      tableWrap.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>PO</th>
              <th>Carrier</th>
              <th>Dept</th>
              <th>Status</th>
              <th>Instruction</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            ${view.map(r => {
              const canCheckIn = (r.status === "Queue");
              const undoOk = canUndo(r);

              let actionHtml = `<button disabled>Done</button>`;
              if (canCheckIn) actionHtml = `<button data-checkin="${r.id}">Checked In</button>`;
              else if (undoOk) actionHtml = `<button data-undo="${r.id}">Undo</button>`;

              return `
                <tr>
                  <td><b>${r.po_number || ""}</b></td>
                  <td>${r.carrier || ""}</td>
                  <td>${r.department || ""}</td>
                  <td>${pill(r.status || "")}</td>
                  <td>${instructionText(r)}</td>
                  <td>${actionHtml}</td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      `;
    }

    async function loadRows(){
      msg.textContent = "Loading…";
      const { data, error } = await supabase
        .from("trucks")
        .select("*")
        .eq("archived", false)
        .order("last_updated", { ascending: false });

      if (error){
        msg.textContent = `Load error: ${error.message}`;
        return;
      }
      msg.textContent = "";
      lastRows = data || [];
      render(lastRows);
    }

    refreshBtn.addEventListener("click", loadRows);
    searchPO.addEventListener("input", () => render(lastRows));
    clearSearchBtn.addEventListener("click", () => { searchPO.value = ""; render(lastRows); });

    // ---- BOL Scan flow ----
    scanBolBtn.addEventListener("click", () => {
      msg.textContent = "Open camera / select BOL photo…";
      bolFile.value = "";
      bolFile.click();
    });

    bolFile.addEventListener("change", async () => {
      const file = bolFile.files?.[0];
      if (!file) return;

      try {
        msg.textContent = "Scanning BOL… (hold steady)";
        const imgUrl = URL.createObjectURL(file);

        // OCR
        const result = await Tesseract.recognize(imgUrl, "eng", {
          logger: (m) => {
            if (m?.status === "recognizing text" && typeof m.progress === "number") {
              msg.textContent = `Scanning BOL… ${Math.round(m.progress * 100)}%`;
            }
          }
        });

        URL.revokeObjectURL(imgUrl);

        const text = (result?.data?.text || "").replace(/\s+/g, " ");
        // Find 5-digit numbers (POs)
        const matches = text.match(/\b\d{5}\b/g) || [];
        const unique = Array.from(new Set(matches));

        if (!unique.length) {
          msg.textContent = "No 5-digit PO found. Try a clearer photo (zoom on the PO).";
          return;
        }

        // If multiple POs detected, let officer choose
        let chosen = unique[0];
        if (unique.length > 1) {
          const pick = prompt(
            `Multiple 5-digit numbers found:\n\n${unique.join(", ")}\n\nType the correct PO:`,
            unique[0]
          );
          if (pick && /^\d{5}$/.test(pick.trim())) chosen = pick.trim();
        }

        searchPO.value = chosen;
        render(lastRows);
        msg.textContent = `PO ${chosen} detected from BOL.`;

      } catch (err) {
        msg.textContent = `BOL scan failed: ${err?.message || err}`;
      }
    });

    // ---- Check-in + Undo ----
    tableWrap.addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;

      const checkId = btn.getAttribute("data-checkin");
      const undoId = btn.getAttribute("data-undo");

      if (checkId) {
        msg.textContent = "Saving…";
        const { error } = await supabase
          .from("trucks")
          .update({ status: "Checked In", last_updated: new Date().toISOString() })
          .eq("id", checkId);

        if (error){
          msg.textContent = `Save error: ${error.message}`;
          return;
        }
        msg.textContent = "Checked in.";
        await loadRows();
        return;
      }

      if (undoId) {
        msg.textContent = "Undoing…";
        const { error } = await supabase
          .from("trucks")
          .update({ status: "Queue", last_updated: new Date().toISOString() })
          .eq("id", undoId);

        if (error){
          msg.textContent = `Undo error: ${error.message}`;
          return;
        }
        msg.textContent = "Restored to Queue.";
        await loadRows();
      }
    });

    loadRows();
    setInterval(loadRows, 20000); // auto refresh
  </script>
</body>
</html>
