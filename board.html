<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Officer Board</title>
  <style>
    body { font-family: system-ui, -apple-system, Arial; padding: 16px; }
    h1 { margin: 0 0 6px; }
    .note { color:#555; font-size:14px; margin-bottom:14px; line-height: 1.35; }
    .row { display:grid; grid-template-columns:1fr auto auto; gap:10px; }
    input, button { padding:12px; font-size:16px; box-sizing: border-box; }
    input { width:100%; }
    button { cursor:pointer; }
    .msg { margin: 10px 0; font-weight:600; }
    table { width:100%; border-collapse:collapse; margin-top:14px; }
    th, td { border:1px solid #ddd; padding:10px; font-size:14px; vertical-align:top; }
    th { background:#f5f5f5; text-align:left; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid #ddd; font-size:12px; }
    .pill.queue { background:#fff; }
    .pill.checked { background:#eefaf0; }
    .big { font-size:16px; font-weight:700; }
    .muted { color:#666; font-size:13px; }
    .btnCheck { width: 100%; }
  </style>
</head>

<body>
  <h1>Officer Board</h1>
  <div class="note">
    Scan BOL → PO autofills → follow instruction → tap <b>Checked In</b>.
    <br>
    If Ledger Door blank: Grocery → 56, Produce/Dairy → 93, Meat/Frozen → 132.
    <br>
    <span class="muted">Archived rows are hidden.</span>
  </div>

  <div class="row">
    <input id="search" placeholder="Search PO (5 digits)…" inputmode="numeric" maxlength="5" />
    <button id="scanBtn">Scan BOL</button>
    <button id="refresh">Refresh</button>
  </div>

  <input id="bolFile" type="file" accept="image/*" capture="environment" style="display:none;" />

  <div class="msg" id="msg"></div>

  <div id="tableWrap"></div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
import Tesseract from "https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.esm.min.js";

const supabase = createClient(
  "https://pxiigthkswhnivanndfn.supabase.co",
  "sb_publishable_fWVXeZM0mcylqczc6DWztA_Fu63kfj0"
);

const msg = document.getElementById("msg");
const tableWrap = document.getElementById("tableWrap");
const search = document.getElementById("search");
const refreshBtn = document.getElementById("refresh");

const scanBtn = document.getElementById("scanBtn");
const bolFile = document.getElementById("bolFile");

let rows = [];

function autoDoor(dept) {
  if (dept === "Grocery") return "56";
  if (dept === "Produce/Dairy") return "93";
  if (dept === "Meat/Frozen") return "132";
  return "";
}

function doorForRow(r) {
  const ld = (r.ledger_door ?? "").toString().trim();
  return ld ? ld : autoDoor(r.department);
}

function pillForStatus(status) {
  const s = (status || "Queue").toLowerCase();
  if (s === "checked in") return `<span class="pill checked">Checked In</span>`;
  return `<span class="pill queue">Queue</span>`;
}

async function loadRows() {
  msg.textContent = "Loading…";

  const { data, error } = await supabase
    .from("trucks")
    .select("po_number, department, ledger_door, carrier, shipper, notes, status, last_updated, archived")
    .eq("archived", false)
    .order("last_updated", { ascending: false });

  if (error) {
    msg.textContent = `Load error: ${error.message}`;
    rows = [];
    render();
    return;
  }

  msg.textContent = "";
  rows = data || [];
  render();
}

function render() {
  const q = search.value.trim();
  const view = q ? rows.filter(r => String(r.po_number || "").includes(q)) : rows;

  if (!view.length) {
    tableWrap.innerHTML = `<p class="muted">No records found.</p>`;
    return;
  }

  tableWrap.innerHTML = `
    <table>
      <thead>
        <tr>
          <th style="width:110px;">PO</th>
          <th>Info</th>
          <th style="width:130px;">Door</th>
          <th style="width:140px;">Status</th>
          <th style="width:160px;">Action</th>
        </tr>
      </thead>
      <tbody>
        ${view.map(r => {
          const door = doorForRow(r) || "—";
          const status = r.status || "Queue";
          const updated = r.last_updated ? new Date(r.last_updated).toLocaleString() : "";
          const isChecked = String(status).toLowerCase() === "checked in";

          return `
            <tr>
              <td class="big">${r.po_number || ""}</td>
              <td>
                <div><b>Dept:</b> ${r.department || ""}</div>
                <div><b>Carrier:</b> ${r.carrier || ""}</div>
                <div><b>Shipper:</b> ${r.shipper || ""}</div>
                <div class="muted"><b>Notes:</b> ${r.notes || ""}</div>
                <div class="muted"><b>Updated:</b> ${updated}</div>
              </td>
              <td class="big">${door}</td>
              <td>${pillForStatus(status)}</td>
              <td>
                <button class="btnCheck" data-checkin="${r.po_number}" ${isChecked ? "disabled" : ""}>
                  ${isChecked ? "Already Checked" : "Checked In"}
                </button>
              </td>
            </tr>
          `;
        }).join("")}
      </tbody>
    </table>
  `;
}

/* --------- OCR: Scan BOL -> find PO --------- */
function extractFiveDigitPOs(text) {
  const matches = text.match(/\b\d{5}\b/g) || [];
  return Array.from(new Set(matches));
}

async function ocrFile(file) {
  msg.textContent = "Scanning BOL…";
  const { data } = await Tesseract.recognize(file, "eng", {
    logger: (m) => {
      if (m.status === "recognizing text") {
        msg.textContent = `Scanning BOL… ${Math.round((m.progress || 0) * 100)}%`;
      }
    }
  });
  return data.text || "";
}

scanBtn.addEventListener("click", () => bolFile.click());

bolFile.addEventListener("change", async () => {
  const file = bolFile.files?.[0];
  if (!file) return;

  try {
    const text = await ocrFile(file);
    const candidates = extractFiveDigitPOs(text);

    if (!candidates.length) {
      msg.textContent = "No 5-digit PO found. Take a clearer photo (zoom to PO area, avoid glare).";
      return;
    }

    let chosen = candidates[0];
    if (candidates.length > 1) {
      const pick = prompt(`Multiple 5-digit numbers found:\n${candidates.join(", ")}\n\nType the correct PO:`);
      if (pick && /^\d{5}$/.test(pick.trim())) chosen = pick.trim();
      else {
        msg.textContent = "No PO selected.";
        return;
      }
    }

    search.value = chosen;
    render();
    msg.textContent = `PO detected: ${chosen}`;
  } catch (err) {
    msg.textContent = `Scan failed: ${err?.message || err}`;
  } finally {
    bolFile.value = "";
  }
});

/* --------- Officer action: Checked In --------- */
search.addEventListener("input", render);
refreshBtn.addEventListener("click", loadRows);

tableWrap.addEventListener("click", async (e) => {
  const btn = e.target.closest("button[data-checkin]");
  if (!btn) return;

  const po = btn.dataset.checkin;
  btn.disabled = true;

  msg.textContent = `Marking PO ${po} as Checked In…`;

  const { error } = await supabase
    .from("trucks")
    .update({ status: "Checked In", last_updated: new Date().toISOString() })
    .eq("po_number", po);

  if (error) {
    msg.textContent = `Check-in failed: ${error.message}`;
    btn.disabled = false;
    return;
  }

  msg.textContent = `PO ${po} checked in.`;
  await loadRows();
});

loadRows();
</script>
</body>
</html>
