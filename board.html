<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Officer Board</title>
  <style>
    body { font-family: -apple-system, system-ui, Arial; padding: 14px; max-width: 1100px; margin: 0 auto; }
    h1 { margin: 0 0 10px; }
    .muted { color:#666; font-size: 13px; }
    input, button { font-size: 18px; padding: 12px; width: 100%; box-sizing: border-box; }
    button { cursor: pointer; }
    .row { display:flex; gap:10px; margin-top:10px; }
    .row > * { flex:1; }
    table { width:100%; border-collapse: collapse; margin-top:12px; }
    th, td { border:1px solid #ddd; padding:8px; font-size:14px; }
    th { background:#f5f5f5; text-align:left; }
    .pill { display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid #ddd; }
    .msg { margin: 10px 0; font-weight: 700; }
  </style>
</head>
<body>
  <h1>Officer Board</h1>
  <div class="muted">
    Search PO → verify instruction → tap <b>Checked In</b>.
    Door rules: ledger door wins; otherwise Grocery→56, Produce/Dairy→93, Meat/Frozen→132.
  </div>

  <p class="msg" id="msg"></p>

  <label style="display:block; margin-top:10px;">Search PO</label>
  <input id="searchPO" maxlength="5" inputmode="numeric" placeholder="Type PO digits…" />

  <div class="row">
    <button id="refreshBtn">Refresh</button>
  </div>

  <div id="tableWrap"></div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    const SUPABASE_URL = "https://pxiigthkswhnivanndfn.supabase.co";
    const SUPABASE_KEY = "sb_publishable_fWVXeZM0mcylqczc6DWztA_Fu63kfj0";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const msg = document.getElementById("msg");
    const tableWrap = document.getElementById("tableWrap");
    const refreshBtn = document.getElementById("refreshBtn");
    const searchPO = document.getElementById("searchPO");

    let lastRows = [];

    function pill(t){ return `<span class="pill">${t}</span>`; }

    function defaultDoorForDept(dept){
      if (dept === "Grocery") return "56";
      if (dept === "Produce/Dairy") return "93";
      if (dept === "Meat/Frozen") return "132";
      return "";
    }

    function instructionDoor(r){
      return (r.ledger_door || "").trim() || defaultDoorForDept(r.department);
    }

    function instructionText(r){
      const d = instructionDoor(r);
      return d ? `Check in at Door ${d}` : "Check in (door not set)";
    }

    function render(rows){
      const q = (searchPO.value || "").trim();
      const view = q ? rows.filter(r => String(r.po_number || "").includes(q)) : rows;

      if (!view.length){
        tableWrap.innerHTML = "<p class='muted'>No matching rows.</p>";
        return;
      }

      tableWrap.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>PO</th>
              <th>Carrier</th>
              <th>Dept</th>
              <th>Status</th>
              <th>Instruction</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            ${view.map(r => {
              const canCheckIn = (r.status === "Queue");
              return `
                <tr>
                  <td><b>${r.po_number || ""}</b></td>
                  <td>${r.carrier || ""}</td>
                  <td>${r.department || ""}</td>
                  <td>${pill(r.status || "")}</td>
                  <td>${instructionText(r)}</td>
                  <td>
                    <button data-checkin="${r.id}" ${canCheckIn ? "" : "disabled"}>
                      ${canCheckIn ? "Checked In" : "Done"}
                    </button>
                  </td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      `;
    }

    async function loadRows(){
      msg.textContent = "Loading…";
      const { data, error } = await supabase
        .from("trucks")
        .select("*")
        .eq("archived", false)
        .order("last_updated", { ascending: false });

      if (error){
        msg.textContent = `Load error: ${error.message}`;
        return;
      }
      msg.textContent = "";
      lastRows = data || [];
      render(lastRows);
    }

    refreshBtn.addEventListener("click", loadRows);
    searchPO.addEventListener("input", () => render(lastRows));

    tableWrap.addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const id = btn.getAttribute("data-checkin");
      if (!id) return;

      msg.textContent = "Saving…";
      const { error } = await supabase
        .from("trucks")
        .update({ status: "Checked In", last_updated: new Date().toISOString() })
        .eq("id", id);

      if (error){
        msg.textContent = `Save error: ${error.message}`;
        return;
      }
      msg.textContent = "Checked in.";
      await loadRows();
    });

    loadRows();
    // Optional: auto-refresh every 20 seconds
    setInterval(loadRows, 20000);
  </script>
</body>
</html>
